{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<!-- [ Main Content ] start -->
<!-- [ breadcrumb ] start -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-12">
            <div class="page-header-title">
                <h5 class="m-b-10">Top 1000 coins</h5>
            </div>
            
        </div>
    </div>
    
</div>
<!-- [ breadcrumb ] end -->
<div class="row">
    

    <table id="myDataTable" class="table table-striped table-bordered custom-row-height">
        <thead>
            <tr>
                <th rowspan="2" class="fit-content custom-row-height">No.</th>
                <th rowspan="2" class="fit-content custom-row-height">Symbol</th>
                <th rowspan="2" class="fit-content custom-row-height">Current Price<br>(USD)</th>
                <th rowspan="2" class="fit-content custom-row-height">Market cap<br>(millions $)</th>
                <th rowspan="2" class="fit-content custom-row-height">Volume change<br>48H</th>
                <th colspan="5" class="fit-content custom-row-height">% change</th>
                <th colspan="2" class="fit-content custom-row-height">candle count</th>
                
                
                <th colspan="5" class="fit-content custom-row-height">% change BTC</th>
                
                <!-- Add more table headers as needed -->
            </tr>
            <tr>
                
                <th class="fit-content custom-row-height">3'</th>
                <th class="fit-content custom-row-height">5'</th>
                <th class="fit-content custom-row-height">15'</th>
                <th class="fit-content custom-row-height">1H</th>
                <th class="fit-content custom-row-height">4H</th>
                <th class="fit-content custom-row-height">7d</th>
                <th class="fit-content custom-row-height">14d</th>
                <th class="fit-content custom-row-height">3'</th>
                <th class="fit-content custom-row-height">5'</th>
                <th class="fit-content custom-row-height">15'</th>
                <th class="fit-content custom-row-height">1H</th>
                <th class="fit-content custom-row-height">4H</th>
                
                <!-- Add more table headers as needed -->
            </tr>
        </thead>
        
    </table>
    
</div>

<!-- [ Main Content ] end -->

<script>
    
    function compare(a,b){
        if(parseFloat(a) > parseFloat(b)){
            return 1;
        }
        else if(parseFloat(a) < parseFloat(b)){
            return -1;
        }
        else{
            return 0;
        }
    }
    $(document).ready(function() {
        $.fn.dataTable.ext.errMode = 'none';
        const dataMap = new Map();
        coindataTable = $('#myDataTable').DataTable(
            {
                "paging": true,
                "autoWidth": true,
                suppressWarnings: false,
                
                columns: [
                    { data: 'no'},
                    { data: 'symbol' }, //or { data: 'MONTH', title: 'Month' }`
                    { data: 'price' ,
                        render: function(data, type, row) {
                            if(row.ffprice != undefined){
                                
                                if (row.ffprice == -1){
                                    return  '<font color="green">▲ </font>' + data;
                                }
                                // Return the cell content with the specified background color
                                    
                                else if(row.ffprice == 1) {
                                    return '<font color="red">▼  </font>' + data;
                                }   
                                    
                                else
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                            }
                            else{
                                return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;;
                            }
                    }},
                    { data: 'market_cap' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffmarket_cap != undefined){
                                    
                                    if (row.ffmarket_cap == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffmarket_cap == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'vol' ,
                        render: function(data, type, row) {
                            if(data == undefined){
                                return "";
                            }
                            else{
                                return data;
                            }
                            
                    }},
                    { data: 'm3' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm3 != undefined){
                                    
                                    if (row.ffm3 == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm3 == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'm5' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm5 != undefined){
                                    
                                    if (row.ffm5 == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm5 == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'm15' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm15 != undefined){
                                    
                                    if (row.ffm15 == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm15 == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'h1' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffh1 != undefined){
                                    
                                    if (row.ffh1 == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffh1 == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'h4' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffh4 != undefined){
                                    
                                    if (row.ffh4 == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffh4 == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'c7' },
                    { data: 'c14' },
                    { data: 'm3BTC' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm3BTC != undefined){
                                    
                                    if (row.ffm3BTC == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm3BTC == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'm5BTC' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm5BTC != undefined){
                                    
                                    if (row.ffm5BTC == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm5BTC == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'm15BTC' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffm15BTC != undefined){
                                    
                                    if (row.ffm15BTC == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffm15BTC == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'h1BTC' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffh1BTC != undefined){
                                    
                                    if (row.ffh1BTC == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffh1BTC == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},
                    { data: 'h4BTC' ,
                        render: function(data, type, row) {
                            if(data != undefined){
                                if(row.ffh4BTC != undefined){
                                    
                                    if (row.ffh4BTC == -1){
                                        return  '<font color="green">▲ </font>' + data;
                                    }
                                    // Return the cell content with the specified background color
                                        
                                    else if(row.ffh4BTC == 1) {
                                        return '<font color="red">▼  </font>' + data;
                                    }   
                                        
                                    else
                                        return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                                else{
                                    return '&nbsp;&nbsp;&nbsp;&nbsp;' + ' ' + data;
                                }
                            }
                    }},

                ],
                
            }
            
        );
        $('#myDataTable').on( 'error.dt', function ( e, settings, techNote, message ) {
            console.log( 'An error has been reported by DataTables: ', message );
            
            

        } ) ;    
        function updateDataTable() {
            // Make an AJAX request to get updated data from the server
            $.ajax({
                url: '{% url 'get_coindata_all'%}', // Replace with your server endpoint URL
                type: 'GET',
                dataType: 'json',
                
                success: function(response) {
                    
                    // Clear existing DataTable data
                    coindataTable.clear();
                    
                    // Add updated data to DataTable
                    // console.log(response.data)
                    // console.log(response.data.length);
                    // i=0
                    // response.data.forEach((rowdata) => {
                        
                    //     symbol = rowdata['symbol'];
                        
                    //     if(dataMap.has(symbol)) {
                            
                    //         oridata = dataMap.get(symbol);
                    //         if(oridata.m3 != undefined && rowdata.m3 !=undefined)
                    //             rowdata.ffm3 = compare(oridata.m3, rowdata.m3);
                    //         if(oridata.m5 != undefined && rowdata.m5 !=undefined)
                    //             rowdata.ffm5 = compare(oridata.m5, rowdata.m5);
                    //         if(oridata.m15 != undefined && rowdata.m15 !=undefined)
                    //             rowdata.ffm15 = compare(oridata.m15, rowdata.m15);
                    //         if(oridata.h1 != undefined && rowdata.h1 !=undefined)
                    //             rowdata.ffh1 = compare(oridata.h1, rowdata.h1);
                    //         if(oridata.h4 != undefined && rowdata.h4 !=undefined)
                    //             rowdata.ffh4 = compare(oridata.h4, rowdata.h4);
                    //         if(oridata.price != undefined && rowdata.price !=undefined)
                    //             rowdata.ffprice = compare(oridata.price, rowdata.price);
                    //         if(oridata.m3BTC != undefined && rowdata.m3BTC !=undefined)
                    //             rowdata.ffm3BTC = compare(oridata.m3BTC, rowdata.m3BTC);
                    //         if(oridata.m5BTC != undefined && rowdata.m5BTC !=undefined)
                    //             rowdata.ffm5BTC = compare(oridata.m5BTC, rowdata.m5BTC);
                    //         if(oridata.m15BTC != undefined && rowdata.m15BTC !=undefined)
                    //             rowdata.ffm15BTC = compare(oridata.m15BTC, rowdata.m15BTC);
                    //         if(oridata.h1BTC != undefined && rowdata.h1BTC !=undefined)
                    //             rowdata.ffh1BTC = compare(oridata.h1BTC, rowdata.h1BTC);
                    //         if(oridata.h4BTC != undefined && rowdata.h4BTC !=undefined)
                    //             rowdata.ffh4BTC = compare(oridata.h4BTC, rowdata.h4BTC);
                    //         if(oridata.market_cap != undefined && rowdata.market_cap !=undefined)
                    //             rowdata.ffmarket_cap = compare(oridata.market_cap, rowdata.market_cap);
                    //         response.data[i] = rowdata
                            
                    //         i++;
                            
                            
                    //     }
                    //     else{
                            
                    //         dataMap.set(symbol,rowdata);
                    //     }
                        
                    // });
                    coindataTable.rows.add(response.data);
                    // Redraw the DataTable
                    // console.log(response.data.length);
                    coindataTable.draw();
                    
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }
        updateDataTable()
        setInterval(updateDataTable, 60000);
    });
</script>
{% endblock content %}